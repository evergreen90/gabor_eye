<!doctype html>
<html lang="ja">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Gabor Eye 3分チャレンジ</title>
    <link rel="stylesheet" href="/static/style.css" />
</head>

<body>
    <header>
        <h1>Gabor Eye 3分チャレンジ</h1>
        <p class="sub">16枚の中から同じガボールパッチを見つけよう（3分）</p>
    </header>

    <main class="container">
        <section class="panel">
            <div class="stats">
                <div>残り時間：<span id="time">180</span> 秒</div>
                <div>スコア：<span id="score">0</span></div>
                <div>ミス：<span id="miss">0</span></div>
            </div>

            <div class="controls">
                <label>難易度
                    <select id="difficulty">
                        <option value="easy">やさしい</option>
                        <option value="normal" selected>ふつう</option>
                        <option value="hard">むずかしい</option>
                    </select>
                </label>
                <label>画像サイズ
                    <select id="size">
                        <option value="112">小</option>
                        <option value="128" selected>中</option>
                        <option value="160">大</option>
                    </select>
                </label>
            </div>

            <div class="buttons">
                <button id="startBtn">スタート</button>
                <button id="restartBtn" disabled>リスタート</button>
            </div>

            <div class="target" style="margin-top: 8px;">
                <div style="color: var(--muted); font-size: 13px; margin-bottom: 6px;">問題（お手本）</div>
                <img id="targetImg" alt="target" style="width: 100%; max-width: 240px; background: var(--tile); border: 1px solid var(--border); border-radius: 10px; padding: 6px;" />
                <div style="color: var(--muted); font-size: 12px; margin-top: 6px;">この画像と同じ画像を盤面から1枚選んでください。</div>
            </div>

            <details class="note">
                <summary>使い方 / 注意</summary>
                <ul>
                    <li>表示されたお手本と同じ画像を1枚選ぶと正解、次のラウンドへ。</li>
                    <li>3分で何問解けるか競います。ベストスコアは端末に保存。</li>
                    <li>本アプリは研究・学習用デモです。効果には個人差があります。体調が悪い場合は中止してください。参考：平松 類 先生の解説や「3分で同じ模様を見つける」形式の紹介。<span
                            class="refs">（資料）</span></li>
                </ul>
            </details>

            <div class="best">
                ベスト：<span id="best">0</span>
            </div>
        </section>

        <section class="board">
            <div id="grid" class="grid"></div>
        </section>
    </main>

    <footer>
        <small>Gabor patch = sinusoidal grating × Gaussian envelope. © demo</small>
    </footer>

    <script>
        const $ = (s) => document.querySelector(s);
        const grid = $("#grid");
        const targetImg = $("#targetImg");
        let timeLeft = 180, timer = null;
        let score = 0, miss = 0;
        let firstPick = null, lock = true;
        let answerPair = null;    // unused in single-select mode
        let roundImages = [];     // 16枚のファイル名
        let targetName = null;    // 問題画像
        let playing = false;

        function setText(id, v) { document.getElementById(id).textContent = v; }

        function saveBest(sc) {
            const best = Number(localStorage.getItem("gabor_best") || 0);
            if (sc > best) { localStorage.setItem("gabor_best", String(sc)); }
            setText("best", localStorage.getItem("gabor_best") || "0");
        }

        function tick() {
            timeLeft -= 1;
            setText("time", timeLeft);
            if (timeLeft <= 0) {
                stopGame();
                alert(`時間切れ！ スコア: ${score}（ミス: ${miss}）`);
            }
        }

        function startTimer() {
            stopTimer();
            timer = setInterval(tick, 1000);
        }
        function stopTimer() {
            if (timer) { clearInterval(timer); timer = null; }
        }

        function startGame() {
            timeLeft = 180; score = 0; miss = 0; firstPick = null;
            setText("time", timeLeft); setText("score", score); setText("miss", miss);
            $("#startBtn").disabled = true; $("#restartBtn").disabled = false;
            playing = true; startTimer();
            nextRound();
        }

        function stopGame() {
            playing = false; lock = true;
            stopTimer(); saveBest(score);
            $("#startBtn").disabled = false; $("#restartBtn").disabled = true;
        }

        async function nextRound() {
            lock = true; firstPick = null;
            const diff = $("#difficulty").value;
            const size = $("#size").value;

            const res = await fetch(`/api/round?difficulty=${diff}&size=${size}`);
            const json = await res.json();
            if (!json.ok) { alert("ラウンド生成に失敗"); return; }
            roundImages = json.images; // 16 unique filenames
            targetName = json.target;  // filename that appears once in grid

            if (targetImg) {
                targetImg.src = `/img/${encodeURIComponent(targetName)}?_t=` + Date.now();
            }

            // グリッド描画
            grid.innerHTML = "";
            for (let i = 0; i < 16; i++) {
                const fname = roundImages[i];
                const url = `/img/${encodeURIComponent(fname)}`;
                const cell = document.createElement("button");
                cell.className = "cell";
                cell.dataset.idx = String(i);
                const img = new Image();
                img.src = url + "?_t=" + Date.now();
                img.alt = "gabor";
                cell.appendChild(img);
                cell.addEventListener("click", onPick);
                grid.appendChild(cell);
            }
            lock = false;
        }

        function onPick(e) {
            if (!playing || lock) return;
            const idx = Number(e.currentTarget.dataset.idx);
            const cell = e.currentTarget;

            cell.classList.add("picked");
            lock = true;
            // 単一選択: クリックした1枚が target と同じなら正解
            const ok = (roundImages[idx] === targetName);
            setTimeout(() => {
                if (ok) {
                    score += 1; setText("score", score);
                    cell.classList.add("correct");
                } else {
                    miss += 1; setText("miss", miss);
                    cell.classList.remove("picked");
                }
                // 成否に関わらず次のラウンドへ
                setTimeout(() => { nextRound(); }, 250);
                firstPick = null; lock = false;
            }, 120);
        }


        window.addEventListener("DOMContentLoaded", () => {
            setText("best", localStorage.getItem("gabor_best") || "0");
            $("#startBtn").addEventListener("click", startGame);
            $("#restartBtn").addEventListener("click", () => { stopGame(); startGame(); });
        });
    </script>
</body>

</html>
